import * as fs from 'fs-extra'
import * as glob from 'glob'
import * as path from 'path'
import {flatMap} from 'lodash'

const WORKSPACE_FILE_PATTERNS = [
  '**/*.graphql',
  'stepzen.config.json',
  'config.yaml',
]

const IGNORED_PATTERNS = ['node_modules/**']

/**
 * Copy StepZen workspace content from one directory to another.
 *
 * Include only the files relevant to StepZen:
 *  - **â€‹/*.graphql
 *  - config.yaml
 *  - stepzen.config.json
 *
 * Exclude all other files.
 * Exclude special folders, e.g. node_modules
 */
export default (srcPath: string, dstPath: string) => {
  if (!fs.existsSync(srcPath)) {
    throw new Error(`Cannot find source directory ${srcPath}`)
  }

  flatMap(WORKSPACE_FILE_PATTERNS, pattern =>
    glob.sync(pattern, {
      cwd: srcPath,
      ignore: IGNORED_PATTERNS,
    }),
  ).forEach(relativePath => {
    const srcFileFullPath = path.join(srcPath, relativePath)
    const dstFileFullPath = path.join(dstPath, relativePath)
    fs.ensureDirSync(path.dirname(dstFileFullPath))
    fs.copyFileSync(srcFileFullPath, dstFileFullPath)
  })
}
